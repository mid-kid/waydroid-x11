#!/bin/sh
set -eu

pids=''
if command -v pipewire > /dev/null; then
    pw_sock="${XDG_RUNTIME_DIR:-/run/pipewrire}/pipewire-0"
    if [ ! -S "$pw_sock" ]; then
        pipewire &
        pids="$pids $!"
        pipewire-pulse &
        pids="$pids $!"
        while [ ! -S "$pw_sock" ]; do sleep .1; done
        wireplumber &
        pids="$pids $!"
    fi
elif command -v pacmd > /dev/null; then
    if ! pacmd info 2>&1 > /dev/null; then
        pulseaudio &
        pids="$pids $!"
    fi
fi

trap 'exit $?' INT QUIT TERM
trap 'waydroid session stop; kill $pids' EXIT
dbus-launch weston --backend=drm -c '@pkgdatadir@/weston.ini' "$@" -- waydroid show-full-ui
