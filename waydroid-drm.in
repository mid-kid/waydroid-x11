#!/bin/sh
set -eu

pids=''
trap 'exit $?' INT QUIT TERM
trap 'waydroid session stop; pkill -P $$ $pids' EXIT

if command -v pacmd > /dev/null && ! pacmd info 2>&1 > /dev/null; then
    if command -v pipewire > /dev/null; then
        pw_sock="${XDG_RUNTIME_DIR:-/run/pipewire}/pipewire-0"
        if [ ! -S "$pw_sock" ]; then
            pipewire &
            pids="$pids $!"
            while [ ! -S "$pw_sock" ]; do sleep .1; done
        fi
        pipewire-pulse &
        pids="$pids $!"
        wireplumber &
        pids="$pids $!"
    else
        pulseaudio &
        pids="$pids $!"
    fi
fi

dbus-launch weston --backend=drm -c '@pkgdatadir@/weston.ini' "$@" -- waydroid show-full-ui
